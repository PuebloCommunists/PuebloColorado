<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login | Organize</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background: linear-gradient(135deg,#ff5252,#000); height:100vh; margin:0; display:flex; align-items:center; justify-content:center; color:white; }
  .container { width:360px; padding:2rem; border-radius:12px; background: rgba(255,255,255,0.06); box-shadow:0 6px 24px rgba(0,0,0,0.4); text-align:center; }
  h2 { margin:0 0 1rem 0; color:white; }
  input { width:92%; padding:10px; margin:8px 0; border-radius:8px; border:none; outline:none; }
  button { width:95%; padding:10px; margin-top:10px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; }
  .btn-white { background:white; color:black; }
  .btn-primary { background:#ff5252; color:white; }
  .toggle { margin-top:15px; color:#ddd; cursor:pointer; font-size:0.95rem; text-decoration:underline; }
  .toggle:hover { color:white; }
  .note { margin-top:8px; font-size:0.85rem; color:#eee; opacity:0.9; }
  .create-account-btn { background:transparent; border:1px solid #fff; color:white; margin-top:5px; }
  .error-message { color: #ff6b6b; font-size:0.85rem; margin-top:5px; display:none; }
</style>
</head>
<body>
<div class="container">
  <h2 id="formTitle">Login</h2>

  <!-- LOGIN FORM (Default) -->
  <form id="loginForm">
    <input id="loginIdentifier" type="text" placeholder="Username or email" required />
    <input id="loginPassword" type="password" placeholder="Password" required />
    <button type="submit" class="btn-white">Login</button>
  </form>

  <!-- CREATE ACCOUNT BUTTON -->
  <button class="create-account-btn" id="createAccountBtn">Create Account</button>

  <!-- SIGNUP FORM (Hidden by default) -->
  <form id="signupForm" style="display:none; margin-top:10px;">
    <input id="signupUsername" type="text" placeholder="Username" required />
    <input id="signupEmail" type="email" placeholder="Email" required />
    <input id="signupPassword" type="password" placeholder="Password" required />
    <div class="error-message" id="signupError"></div>
    <button id="signupBtn" type="submit" class="btn-primary">Create Account</button>
    <div class="toggle" id="backToLogin">‚Üê Back to Login</div>
  </form>

  <div class="note" id="noteText"></div>
</div>

<script>
const USERS_KEY = "users";
const LOGGED_IN_KEY = "loggedInUser";

// Read users from localStorage
function readUsers() {
  try {
    return JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  } catch(e) {
    return [];
  }
}

// Save users to localStorage
function writeUsers(users) {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

// Update UI depending on existing users
function updateUI() {
  const users = readUsers();
  const hasUsers = users.length > 0;
  const noteText = document.getElementById("noteText");

  if(!hasUsers) {
    // No users yet: automatically show signup form
    showSignupForm();
    noteText.innerText = "First account created will be admin.";
  } else {
    // Users exist: show login first (default)
    showLoginForm();
    noteText.innerText = "";
  }
}

function showLoginForm() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('createAccountBtn').style.display = 'block';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('formTitle').innerText = 'Login';
  document.getElementById('signupError').style.display = 'none';
  document.getElementById('signupForm').reset();
}

function showSignupForm() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('createAccountBtn').style.display = 'none';
  document.getElementById('signupForm').style.display = 'block';
  document.getElementById('formTitle').innerText = 'Create Account';
  document.getElementById('signupError').style.display = 'none';
}

// Check if username or email already exists
function isDuplicateAccount(username, email) {
  const users = readUsers();
  return users.some(user => 
    user.username.toLowerCase() === username.toLowerCase() || 
    user.email.toLowerCase() === email.toLowerCase()
  );
}

// LOGIN HANDLER
document.getElementById("loginForm").addEventListener("submit", function(evt) {
  evt.preventDefault();
  const identifier = document.getElementById("loginIdentifier").value.trim();
  const password = document.getElementById("loginPassword").value;
  const users = readUsers();
  const user = users.find(u => (u.username === identifier || u.email === identifier) && u.password === password);
  if(user) {
    localStorage.setItem(LOGGED_IN_KEY, JSON.stringify(user));
    alert("Welcome back, " + user.username + (user.role === "admin" ? " (admin)" : "") + "!");
    window.location.href = "index.html";
  } else {
    alert("Invalid username/email or password.");
  }
});

// SIGNUP HANDLER
document.getElementById("signupForm").addEventListener("submit", function(evt) {
  evt.preventDefault();
  const username = document.getElementById("signupUsername").value.trim();
  const email = document.getElementById("signupEmail").value.trim();
  const password = document.getElementById("signupPassword").value;
  const errorElement = document.getElementById("signupError");

  // Clear previous errors
  errorElement.style.display = 'none';

  if(!username || !email || !password) {
    errorElement.textContent = "Please enter all fields.";
    errorElement.style.display = 'block';
    return;
  }

  // Check for duplicate accounts
  if(isDuplicateAccount(username, email)) {
    errorElement.textContent = "Username or email already exists. Please choose different credentials.";
    errorElement.style.display = 'block';
    return;
  }

  const users = readUsers();
  
  // Check if admin already exists - if so, new users are always "user" role
  const adminExists = users.some(user => user.role === "admin");
  const role = adminExists ? "user" : "admin";
  
  users.push({username, email, password, role});
  writeUsers(users);
  
  if(role === "admin") {
    alert("Admin account created successfully! You can now log in.");
  } else {
    alert("Account created successfully! You can now log in.");
  }
  
  document.getElementById("signupForm").reset();
  showLoginForm();
  updateUI();
});

// CREATE ACCOUNT BUTTON HANDLER
document.getElementById("createAccountBtn").addEventListener("click", function() {
  showSignupForm();
});

// BACK TO LOGIN HANDLER
document.getElementById("backToLogin").addEventListener("click", function() {
  showLoginForm();
});

// initial UI setup
updateUI();
</script>
</body>
</html>