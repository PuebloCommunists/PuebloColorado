<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login | Organize</title>
<style>
  :root { --red: #e63946; --dark-red: #c1121f; --yellow: #ffd166; --dark-blue: #1d3557; --light: #f1faee; }
  body { font-family: Arial, Helvetica, sans-serif; background: linear-gradient(135deg,#ff5252,#000); height:100vh; margin:0; display:flex; align-items:center; justify-content:center; color:white; }
  .container { width:360px; padding:2rem; border-radius:12px; background: rgba(255,255,255,0.06); box-shadow:0 6px 24px rgba(0,0,0,0.4); text-align:center; }
  h2 { margin:0 0 1rem 0; color:white; }
  input { width:92%; padding:10px; margin:8px 0; border-radius:8px; border:none; outline:none; }
  button { width:95%; padding:10px; margin-top:10px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; }
  .btn-white { background:white; color:black; }
  .btn-primary { background:#ff5252; color:white; }
  .toggle { margin-top:15px; color:#ddd; cursor:pointer; font-size:0.95rem; text-decoration:underline; }
  .toggle:hover { color:white; }
  .note { margin-top:8px; font-size:0.85rem; color:#eee; opacity:0.9; }
  .create-account-btn { background:transparent; border:1px solid #fff; color:white; margin-top:5px; }
  .error-message { color: #ff6b6b; font-size:0.85rem; margin-top:5px; display:none; }
  .success-message { color: var(--yellow); font-size:0.9rem; margin-top:10px; padding:10px; background:rgba(255,209,102,0.1); border-radius:5px; }
  .sync-status { font-size:0.8rem; color:#aaa; margin-top:10px; }
</style>
</head>
<body>
<div class="container">
  <h2 id="formTitle">Login</h2>

  <!-- LOGIN FORM (Default) -->
  <form id="loginForm">
    <input id="loginIdentifier" type="text" placeholder="Username or email" required />
    <input id="loginPassword" type="password" placeholder="Password" required />
    <button type="submit" class="btn-white" id="loginBtn">Login</button>
  </form>

  <!-- CREATE ACCOUNT BUTTON -->
  <button class="create-account-btn" id="createAccountBtn">Create Account</button>

  <!-- SIGNUP FORM (Hidden by default) -->
  <form id="signupForm" style="display:none; margin-top:10px;">
    <input id="signupUsername" type="text" placeholder="Choose Username" required />
    <input id="signupEmail" type="email" placeholder="Your Email" required />
    <input id="signupPassword" type="password" placeholder="Create Password" required />
    <div class="error-message" id="signupError"></div>
    <div class="success-message" id="signupSuccess" style="display:none;">
      ‚úÖ Registration submitted! We'll review and activate your account soon.
    </div>
    <button id="signupBtn" type="submit" class="btn-primary">Submit Registration</button>
    <div class="toggle" id="backToLogin">‚Üê Back to Login</div>
  </form>

  <div class="note" id="noteText"></div>
  <div class="sync-status" id="syncStatus">üîÑ Connecting to server...</div>
</div>

<script>
const SERVER_URL = 'http://10.0.0.121:3000';

// Server API calls
async function loadUsersFromServer() {
  try {
    const response = await fetch(`${SERVER_URL}/users`);
    if (!response.ok) throw new Error('Server load failed');
    const data = await response.json();
    document.getElementById('syncStatus').textContent = '‚úÖ Connected to server';
    return data;
  } catch (error) {
    document.getElementById('syncStatus').textContent = '‚ùå Offline mode (using local storage)';
    console.error('Server load failed:', error);
    return loadUsersFromLocal();
  }
}

async function saveUsersToServer(usersData) {
  try {
    const response = await fetch(`${SERVER_URL}/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(usersData)
    });
    
    if (!response.ok) throw new Error('Server save failed');
    
    document.getElementById('syncStatus').textContent = '‚úÖ Changes saved to server';
    return true;
  } catch (error) {
    document.getElementById('syncStatus').textContent = '‚ùå Save failed (using local storage)';
    console.error('Server save failed:', error);
    saveUsersToLocal(usersData);
    return false;
  }
}

// Local storage fallback (same as before)
function loadUsersFromLocal() {
  try {
    return JSON.parse(localStorage.getItem('acpUsers')) || { activeUsers: [], pendingUsers: [] };
  } catch(e) {
    return { activeUsers: [], pendingUsers: [] };
  }
}

function saveUsersToLocal(usersData) {
  localStorage.setItem('acpUsers', JSON.stringify(usersData));
}

// Password hashing (same as before)
function generateSalt() {
  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

function hashPassword(password, salt) {
  let hash = 0;
  const combined = password + salt;
  for (let i = 0; i < combined.length; i++) {
    const char = combined.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  for (let i = 0; i < 1000; i++) {
    hash = ((hash << 5) - hash) + salt.charCodeAt(i % salt.length);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36) + combined.length;
}

function verifyPassword(password, salt, storedHash) {
  const testHash = hashPassword(password, salt);
  return testHash === storedHash;
}

// Update UI (same as before)
async function updateUI() {
  const usersData = await loadUsersFromServer();
  const hasUsers = usersData.activeUsers.length > 0 || usersData.pendingUsers.length > 0;
  const noteText = document.getElementById("noteText");

  if(!hasUsers) {
    showSignupForm();
    noteText.innerText = "First account created will be admin.";
  } else {
    showLoginForm();
    noteText.innerText = "";
  }
}

function showLoginForm() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('createAccountBtn').style.display = 'block';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('formTitle').innerText = 'Login';
  document.getElementById('signupError').style.display = 'none';
  document.getElementById('signupSuccess').style.display = 'none';
  document.getElementById('signupForm').reset();
}

function showSignupForm() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('createAccountBtn').style.display = 'none';
  document.getElementById('signupForm').style.display = 'block';
  document.getElementById('formTitle').innerText = 'Create Account';
  document.getElementById('signupError').style.display = 'none';
  document.getElementById('signupSuccess').style.display = 'none';
}

// Check if username or email already exists
async function isDuplicateAccount(username, email) {
  const usersData = await loadUsersFromServer();
  const allUsers = [...usersData.activeUsers, ...usersData.pendingUsers];
  
  return allUsers.some(user => 
    user.username.toLowerCase() === username.toLowerCase() || 
    user.email.toLowerCase() === email.toLowerCase()
  );
}

// LOGIN HANDLER - UPDATED FOR DIRECT SERVER LOGIN
document.getElementById("loginForm").addEventListener("submit", async function(evt) {
  evt.preventDefault();
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.textContent = 'Logging in...';
  loginBtn.disabled = true;

  const identifier = document.getElementById("loginIdentifier").value.trim();
  const password = document.getElementById("loginPassword").value;

  try {
    const response = await fetch(`${SERVER_URL}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: identifier, password })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      // Store user session
      localStorage.setItem('loggedInUser', JSON.stringify(result.user));
      alert("Welcome back, " + result.user.username + (result.user.role === "admin" ? " (admin)" : "") + "!");
      window.location.href = "index.html";
    } else {
      alert(result.error || "Login failed");
    }
  } catch (error) {
    alert("Server connection failed. Trying local login...");
    // Fallback to local login
    const usersData = await loadUsersFromServer();
    const user = usersData.activeUsers.find(u => 
      (u.username === identifier || u.email === identifier) && 
      verifyPassword(password, u.salt, u.passwordHash)
    );
    
    if(user) {
      localStorage.setItem('loggedInUser', JSON.stringify({
        username: user.username,
        email: user.email,
        role: user.role
      }));
      alert("Welcome back, " + user.username + (user.role === "admin" ? " (admin)" : "") + "!");
      window.location.href = "index.html";
    } else {
      alert("Invalid username/email or password, or account not yet activated.");
    }
  }
  
  loginBtn.textContent = 'Login';
  loginBtn.disabled = false;
});

// SIGNUP HANDLER - UPDATED FOR DIRECT SERVER REGISTRATION
document.getElementById("signupForm").addEventListener("submit", async function(evt) {
  evt.preventDefault();
  const signupBtn = document.getElementById('signupBtn');
  signupBtn.textContent = 'Submitting...';
  signupBtn.disabled = true;

  const username = document.getElementById("signupUsername").value.trim();
  const email = document.getElementById("signupEmail").value.trim();
  const password = document.getElementById("signupPassword").value;
  const errorElement = document.getElementById("signupError");
  const successElement = document.getElementById("signupSuccess");

  errorElement.style.display = 'none';
  successElement.style.display = 'none';

  if(!username || !email || !password) {
    errorElement.textContent = "Please enter all fields.";
    errorElement.style.display = 'block';
    signupBtn.textContent = 'Submit Registration';
    signupBtn.disabled = false;
    return;
  }

  try {
    const response = await fetch(`${SERVER_URL}/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, email, password })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      successElement.style.display = 'block';
      document.getElementById("signupForm").reset();
      
      // Auto-return to login after 3 seconds
      setTimeout(() => {
        showLoginForm();
        updateUI();
      }, 3000);
    } else {
      errorElement.textContent = result.error || "Registration failed";
      errorElement.style.display = 'block';
    }
  } catch (error) {
    errorElement.textContent = "Server connection failed. Please try again.";
    errorElement.style.display = 'block';
  }
  
  signupBtn.textContent = 'Submit Registration';
  signupBtn.disabled = false;
});

// CREATE ACCOUNT BUTTON HANDLER
document.getElementById("createAccountBtn").addEventListener("click", function() {
  showSignupForm();
});

// BACK TO LOGIN HANDLER
document.getElementById("backToLogin").addEventListener("click", function() {
  showLoginForm();
});

// initial UI setup
updateUI();
</script>
</body>
</html>