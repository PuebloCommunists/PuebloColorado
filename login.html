<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login | Organize</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background: linear-gradient(135deg,#ff5252,#000); height:100vh; margin:0; display:flex; align-items:center; justify-content:center; color:white; }
  .container { width:360px; padding:2rem; border-radius:12px; background: rgba(255,255,255,0.06); box-shadow:0 6px 24px rgba(0,0,0,0.4); text-align:center; }
  h2 { margin:0 0 1rem 0; color:white; }
  input { width:92%; padding:10px; margin:8px 0; border-radius:8px; border:none; outline:none; }
  button { width:95%; padding:10px; margin-top:10px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; }
  .btn-white { background:white; color:black; }
  .btn-primary { background:#ff5252; color:white; }
  .toggle { margin-top:15px; color:#ddd; cursor:pointer; font-size:0.95rem; text-decoration:underline; }
  .toggle:hover { color:white; }
  .note { margin-top:8px; font-size:0.85rem; color:#eee; opacity:0.9; }
  .create-account-btn { background:transparent; border:1px solid #fff; color:white; margin-top:5px; }
  .error-message { color: #ff6b6b; font-size:0.85rem; margin-top:5px; display:none; }
</style>
</head>
<body>
<div class="container">
  <h2 id="formTitle">Login</h2>

  <!-- LOGIN FORM (Default) -->
  <form id="loginForm">
    <input id="loginIdentifier" type="text" placeholder="Username or email" required />
    <input id="loginPassword" type="password" placeholder="Password" required />
    <button type="submit" class="btn-white" id="loginBtn">Login</button>
  </form>

  <!-- CREATE ACCOUNT BUTTON -->
  <button class="create-account-btn" id="createAccountBtn">Create Account</button>

  <!-- SIGNUP FORM (Hidden by default) -->
  <form id="signupForm" style="display:none; margin-top:10px;">
    <input id="signupUsername" type="text" placeholder="Username" required />
    <input id="signupEmail" type="email" placeholder="Email" required />
    <input id="signupPassword" type="password" placeholder="Password" required />
    <div class="error-message" id="signupError"></div>
    <button id="signupBtn" type="submit" class="btn-primary">Create Account</button>
    <div class="toggle" id="backToLogin">‚Üê Back to Login</div>
  </form>

  <div class="note" id="noteText"></div>
</div>

<script>
// Google Sheets setup
const SHEET_ID = '1HWG_fy9G4BmX7I2TompW2rltgXzGQh3-6O4yjlkCDCk';
const SHEET_NAME = 'Sheet1';

// SECURITY: Password hashing functions
function generateSalt() {
  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

function hashPassword(password, salt) {
  // Simple but effective hashing - much better than plain text
  let hash = 0;
  const combined = password + salt;
  for (let i = 0; i < combined.length; i++) {
    const char = combined.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  // Add multiple rounds and include salt in final hash
  for (let i = 0; i < 1000; i++) {
    hash = ((hash << 5) - hash) + salt.charCodeAt(i % salt.length);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36) + combined.length;
}

function verifyPassword(password, salt, storedHash) {
  const testHash = hashPassword(password, salt);
  return testHash === storedHash;
}

// Google Sheets API functions
async function appendUserToSheet(userData) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A:F:append?valueInputOption=RAW`;
  
  const values = [
    [
      userData.username,
      userData.email,
      userData.passwordHash, // STORE HASHED PASSWORD
      userData.salt,         // STORE SALT
      userData.role,
      new Date().toISOString()
    ]
  ];
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ values })
    });
    return response.ok;
  } catch (error) {
    console.error('Error saving to sheet:', error);
    return false;
  }
}

async function getUsersFromSheet() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A2:F`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.values) {
      return data.values.map(row => ({
        username: row[0],
        email: row[1],
        passwordHash: row[2], // READ HASHED PASSWORD
        salt: row[3],         // READ SALT
        role: row[4],
        timestamp: row[5]
      }));
    }
    return [];
  } catch (error) {
    console.error('Error reading from sheet:', error);
    return [];
  }
}

// Update UI
async function updateUI() {
  const users = await getUsersFromSheet();
  const hasUsers = users.length > 0;
  const noteText = document.getElementById("noteText");

  if(!hasUsers) {
    showSignupForm();
    noteText.innerText = "First account created will be admin.";
  } else {
    showLoginForm();
    noteText.innerText = "";
  }
}

function showLoginForm() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('createAccountBtn').style.display = 'block';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('formTitle').innerText = 'Login';
  document.getElementById('signupError').style.display = 'none';
  document.getElementById('signupForm').reset();
}

function showSignupForm() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('createAccountBtn').style.display = 'none';
  document.getElementById('signupForm').style.display = 'block';
  document.getElementById('formTitle').innerText = 'Create Account';
  document.getElementById('signupError').style.display = 'none';
}

// Check if username or email already exists
async function isDuplicateAccount(username, email) {
  const users = await getUsersFromSheet();
  return users.some(user => 
    user.username.toLowerCase() === username.toLowerCase() || 
    user.email.toLowerCase() === email.toLowerCase()
  );
}

// SECURE LOGIN HANDLER
document.getElementById("loginForm").addEventListener("submit", async function(evt) {
  evt.preventDefault();
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.textContent = 'Logging in...';
  loginBtn.disabled = true;

  const identifier = document.getElementById("loginIdentifier").value.trim();
  const password = document.getElementById("loginPassword").value;
  const users = await getUsersFromSheet();
  
  // SECURITY: Verify hashed password
  const user = users.find(u => 
    (u.username === identifier || u.email === identifier) && 
    verifyPassword(password, u.salt, u.passwordHash) // VERIFY PASSWORD SECURELY
  );
  
  if(user) {
    localStorage.setItem('loggedInUser', JSON.stringify({
      username: user.username,
      email: user.email,
      role: user.role
      // DON'T store password in localStorage
    }));
    alert("Welcome back, " + user.username + (user.role === "admin" ? " (admin)" : "") + "!");
    window.location.href = "index.html";
  } else {
    alert("Invalid username/email or password.");
  }
  
  loginBtn.textContent = 'Login';
  loginBtn.disabled = false;
});

// SECURE SIGNUP HANDLER
document.getElementById("signupForm").addEventListener("submit", async function(evt) {
  evt.preventDefault();
  const signupBtn = document.getElementById('signupBtn');
  signupBtn.textContent = 'Creating Account...';
  signupBtn.disabled = true;

  const username = document.getElementById("signupUsername").value.trim();
  const email = document.getElementById("signupEmail").value.trim();
  const password = document.getElementById("signupPassword").value;
  const errorElement = document.getElementById("signupError");

  errorElement.style.display = 'none';

  if(!username || !email || !password) {
    errorElement.textContent = "Please enter all fields.";
    errorElement.style.display = 'block';
    signupBtn.textContent = 'Create Account';
    signupBtn.disabled = false;
    return;
  }

  if(await isDuplicateAccount(username, email)) {
    errorElement.textContent = "Username or email already exists. Please choose different credentials.";
    errorElement.style.display = 'block';
    signupBtn.textContent = 'Create Account';
    signupBtn.disabled = false;
    return;
  }

  const users = await getUsersFromSheet();
  const adminExists = users.some(user => user.role === "admin");
  const role = adminExists ? "user" : "admin";
  
  // SECURITY: Hash password before storing
  const salt = generateSalt();
  const passwordHash = hashPassword(password, salt);
  
  const userData = { 
    username, 
    email, 
    passwordHash, // STORE HASHED PASSWORD
    salt,          // STORE SALT
    role 
  };
  
  const success = await appendUserToSheet(userData);
  
  if(success) {
    if(role === "admin") {
      alert("Admin account created successfully! You can now log in.");
    } else {
      alert("Account created successfully! You can now log in.");
    }
  } else {
    alert("Error creating account. Please try again.");
  }
  
  document.getElementById("signupForm").reset();
  showLoginForm();
  updateUI();
  
  signupBtn.textContent = 'Create Account';
  signupBtn.disabled = false;
});

// CREATE ACCOUNT BUTTON HANDLER
document.getElementById("createAccountBtn").addEventListener("click", function() {
  showSignupForm();
});

// BACK TO LOGIN HANDLER
document.getElementById("backToLogin").addEventListener("click", function() {
  showLoginForm();
});

// initial UI setup
updateUI();
</script>
</body>
</html>